<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viego: The Ruined King RPG</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        :root {
            --ruined-green: #0ac8b9;
            --dark-bg: #05080a;
            --power-yellow: #f1c40f;
            --hp-red: #c0392b;
            --crit-color: #ffcc00;
            --heal-color: #2ecc71;
            --gold-color: #f39c12;
            --sell-color: #e74c3c;
        }

        body {
            background-color: var(--dark-bg);
            /* Arka plan g√∂rseli */
            background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,10,10,0.9)), url('https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Viego_0.jpg');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: #e0e0e0; font-family: 'Cinzel', serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden; user-select: none;
            transition: filter 1s ease, box-shadow 1s ease;
            position: relative;
        }
        body.death-realm-active { filter: grayscale(100%) sepia(30%) hue-rotate(90deg) contrast(1.1); box-shadow: inset 0 0 150px #0ac8b9; }

        /* --- WEBGL CANVAS STƒ∞Lƒ∞ --- */
        #mist-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* Arka planƒ±n √ºst√ºnde, UI'ƒ±n altƒ±nda */
            pointer-events: none; /* Tƒ±klamalarƒ±n arkaya ge√ßmesini saƒülar */
            mix-blend-mode: screen; /* Sisin arka planla g√ºzel karƒ±≈ümasƒ± i√ßin */
            opacity: 0.8;
        }

        /* --- UI ELEMENTLERƒ∞ (Z-Index: 10 ve √ºzeri) --- */
        .game-wrapper, .top-bar-controls, #inventory-frame, .back-btn, #info-modal, #shop-modal, #restart-modal { position: relative; z-index: 10; }

        .info-btn { position: absolute; top: 5px; left: 5px; width: 25px; height: 25px; background: rgba(0,0,0,0.9); border: 1px solid var(--ruined-green); color: var(--ruined-green); border-radius: 50%; font-weight: bold; cursor: pointer; z-index: 100; display: flex; justify-content: center; align-items: center; transition: 0.3s; }
        .info-btn:hover { background: var(--ruined-green); color: black; transform: scale(1.1); }
        
        .info-modal, .overlay-msg, .dialogue-box, #final-choice-overlay, #shop-modal, #restart-modal { background: rgba(10, 12, 15, 0.98); border: 2px solid #1a1a1a; outline: 2px solid var(--ruined-green); outline-offset: -2px; box-shadow: 0 0 40px rgba(10, 200, 185, 0.2); border-radius: 4px; color: #ddd; text-align: center; }
        .info-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; padding: 20px; z-index: 2000; display: none; text-align: left; font-family: 'Roboto', sans-serif; font-size: 13px; line-height: 1.6; }
        .info-modal h3 { color: var(--ruined-green); margin-top: 0; text-align: center; border-bottom: 1px solid #444; padding-bottom: 10px; font-family: 'Cinzel', serif; }
        .info-strong { color: #e74c3c; font-weight: bold; display: block; margin-top: 5px; } .info-weak { color: #2ecc71; font-weight: bold; display: block; margin-top: 5px; }
        .info-close { margin-top: 15px; width: 100%; background: #333; color: white; border: 1px solid #555; padding: 8px; cursor: pointer; font-family: 'Cinzel', serif; transition: 0.2s; } .info-close:hover { background: var(--ruined-green); color: black; }

        .level-badge { position: absolute; top: -15px; right: 50%; transform: translateX(50%); width: 35px; height: 35px; background: var(--ruined-green); color: black; border: 2px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-family: sans-serif; font-size: 16px; box-shadow: 0 0 15px var(--ruined-green); z-index: 20; }
        #enemy-lvl { background: transparent !important; border: none !important; box-shadow: none !important; color: #d63031 !important; text-shadow: 0 0 5px black, 0 0 10px black; font-size: 28px; font-family: 'Cinzel', serif; top: -30px; }

        #restart-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 400px; padding: 30px; z-index: 3000; display: none; font-family: 'Cinzel', serif; }
        #restart-modal h3 { color: var(--hp-red); font-size: 1.5rem; margin: 0 0 15px 0; text-shadow: 0 0 10px red; border-bottom: 1px solid #444; padding-bottom: 10px;}
        #restart-modal p { font-family: 'Roboto', sans-serif; color: #ccc; margin-bottom: 25px; font-size: 1rem; }
        .modal-btn-container { display: flex; justify-content: center; gap: 20px; }
        .modal-btn { padding: 12px 25px; border: 2px solid; background: rgba(0,0,0,0.6); font-family: 'Cinzel'; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; }
        .btn-confirm { border-color: var(--hp-red); color: var(--hp-red); } .btn-confirm:hover { background: var(--hp-red); color: white; box-shadow: 0 0 20px var(--hp-red); }
        .btn-cancel { border-color: var(--ruined-green); color: var(--ruined-green); } .btn-cancel:hover { background: var(--ruined-green); color: black; box-shadow: 0 0 20px var(--ruined-green); }

        #shop-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 650px; padding: 20px; z-index: 2100; display: none; text-align: left; }
        .shop-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .shop-item { background: rgba(0,0,0,0.6); border: 1px solid #444; padding: 10px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; position: relative; }
        .shop-item:hover { border-color: var(--ruined-green); background: rgba(10, 200, 185, 0.1); }
        .shop-item.owned-passive { border-color: var(--gold-color); }
        .item-info { display: flex; flex-direction: column; }
        .item-name { font-weight: bold; color: #fff; font-size: 0.9rem; }
        .item-desc { font-size: 0.75rem; color: #aaa; font-family: 'Roboto', sans-serif; }
        .buy-btn { background: #333; color: var(--gold-color); border: 1px solid var(--gold-color); padding: 5px 10px; cursor: pointer; font-weight: bold; font-family: 'Cinzel'; transition: 0.2s; }
        .buy-btn:hover:not(:disabled) { background: var(--gold-color); color: black; }
        .buy-btn:disabled { opacity: 0.5; filter: grayscale(100%); cursor: not-allowed; }
        body.sell-mode-active .shop-item.owned-passive, body.sell-mode-active .shop-item.owned-consumable { border-color: var(--sell-color); background: rgba(231, 76, 60, 0.1); }
        body.sell-mode-active .buy-btn.sellable { background: var(--sell-color); color: white; border-color: #c0392b; }
        body.sell-mode-active .buy-btn.sellable:hover { background: #c0392b; }
        #sell-mode-btn { margin-right: 10px; background: #333; color: #aaa; border: 1px solid #555; }
        #sell-mode-btn.active { background: var(--sell-color); color: white; border-color: #c0392b; }

        .game-wrapper { width: 95%; max-width: 800px; height: 650px; background: rgba(8, 10, 12, 0.95); border: 5px solid #1a1a1a; outline: 3px solid var(--ruined-green); outline-offset: -2px; box-shadow: 0 0 40px 5px rgba(10, 200, 185, 0.4); padding: 25px; position: relative; display: flex; flex-direction: column; border-radius: 8px; }
        #start-screen, #cinematic-dialogue, #overlay, #final-choice-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border-radius: 8px; }
        #start-screen { background: rgba(0,0,0,0.95); z-index: 200; }
        #overlay, #final-choice-overlay { background: rgba(0,0,0,0.9); display: none; }
        .overlay-msg h2 { color: var(--ruined-green); font-size: 2.5rem; text-shadow: 0 0 10px var(--ruined-green); }
        #cinematic-dialogue { display: none; justify-content: flex-end; padding-bottom: 50px; background: rgba(0,0,0,0.4); pointer-events: none; }
        .dialogue-box { padding: 25px; width: 70%; pointer-events: auto; min-height: 100px; background: rgba(10,12,15,0.95); border: 2px solid var(--ruined-green); }
        #cinematic-text { font-size: 1.3rem; color: #fff; font-style: italic; }
        .start-btn, #cinematic-btn { background: transparent; border: 2px solid var(--ruined-green); color: var(--ruined-green); padding: 10px 30px; cursor: pointer; font-family: 'Cinzel', serif; transition: 0.3s; font-size: 1.2rem; margin: 5px; }
        .start-btn:hover, #cinematic-btn:hover { background: var(--ruined-green); color: black; box-shadow: 0 0 20px var(--ruined-green); }
        .choice-btn { padding: 20px 40px; margin: 10px; font-size: 1.2rem; border: 2px solid; cursor: pointer; font-family: 'Cinzel', serif; width: 300px; transition: 0.3s; background: rgba(0,0,0,0.8); }
        .btn-attack { border-color: #c0392b; color: #c0392b; } .btn-attack:hover { background: #c0392b; color: white; }
        .btn-surrender { border-color: #2ecc71; color: #2ecc71; } .btn-surrender:hover { background: #2ecc71; color: white; }

        .battle-scene { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; position: relative; }
        .character-box { width: 250px; text-align: center; position: relative; transition: transform 0.2s; }
        
        /* --- RESƒ∞M D√úZENLEMESƒ∞ BURADA --- */
        .character-img { 
            width: 200px; height: 200px; 
            object-fit: cover; 
            object-position: center top; 
            border-radius: 50%; 
            border: 4px solid #444; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            transition: all 0.2s; 
        }
        
        .viego-glow { border-color: var(--ruined-green); box-shadow: 0 0 30px rgba(10, 200, 185, 0.3); }
        .enemy-glow { border-color: #d63031; box-shadow: 0 0 30px rgba(214, 48, 49, 0.3); }
        .attacking { animation: attack-motion 0.3s ease-in-out; }
        @keyframes attack-motion { 0% { transform: translateX(0); } 50% { transform: translateX(30px); } 100% { transform: translateX(0); } }
        #enemy-box.attacking { animation: enemy-attack-motion 0.3s ease-in-out; }
        @keyframes enemy-attack-motion { 0% { transform: translateX(0); } 50% { transform: translateX(-30px); } 100% { transform: translateX(0); } }
        .damaged .character-img { animation: shake 0.4s, flash-red 0.4s; }
        @keyframes shake { 0%, 100% { transform: translate(0, 0); } 20% { transform: translate(-5px, 5px); } 40% { transform: translate(5px, -5px); } 60% { transform: translate(-5px, 0); } 80% { transform: translate(5px, 0); } }
        @keyframes flash-red { 0%, 100% { filter: none; } 50% { filter: sepia(1) saturate(5) hue-rotate(-50deg); } }
        .clone-active { opacity: 0.6; filter: grayscale(80%) blur(1px); border-color: #a29bfe; animation: pulseClone 1s infinite alternate; }

        .stat-bar { width: 100%; height: 18px; background: #222; margin-top: 10px; border: 1px solid #444; position: relative; }
        .fill { height: 100%; transition: width 0.4s ease-out; } .hp-fill { background-color: var(--hp-red); } .power-fill { background-color: var(--power-yellow); box-shadow: 0 0 10px var(--power-yellow); } .shield-fill { background-color: #95a5a6; position: absolute; height: 100%; opacity: 0.7; }
        .bar-text { font-size: 13px; font-weight: bold; position: absolute; top: 0; right: 5px; color: #fff; text-shadow: 1px 1px 2px black; line-height: 18px; }
        .gold-display { position: absolute; top: -30px; right: 0; color: var(--gold-color); font-weight: bold; font-size: 16px; display: flex; align-items: center; gap: 5px; }

        #inventory-frame { position: fixed; top: 80px; left: 20px; width: 70px; background: rgba(10, 12, 15, 0.95); border: 2px solid var(--ruined-green); border-radius: 6px; padding: 10px; display: flex; flex-direction: column; gap: 15px; z-index: 1000; }
        .inv-slot { width: 100%; height: 60px; background: #222; border: 1px solid #444; border-radius: 4px; position: relative; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 28px; }
        .inv-slot:hover { border-color: var(--ruined-green); background: #333; } .inv-slot.empty { opacity: 0.5; filter: grayscale(100%); }
        .inv-count { position: absolute; bottom: 2px; right: 2px; font-size: 11px; font-weight: bold; background: rgba(0,0,0,0.8); padding: 1px 5px; border-radius: 4px; }
        #equipped-container { position: absolute; top: 50px; left: -60px; width: 50px; display: flex; flex-direction: column; gap: 8px; z-index: 50; }
        .eq-item { width: 40px; height: 40px; background: rgba(0,0,0,0.8); border: 1px solid var(--gold-color); border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 20px; position: relative; cursor: help; }
        .eq-lvl { position: absolute; bottom: -2px; right: -2px; background: var(--gold-color); color: black; font-size: 9px; padding: 1px 3px; font-weight: bold; border-radius: 2px; }
        #inv-tooltip { position: absolute; background: rgba(10, 12, 15, 0.98); border: 1px solid var(--ruined-green); box-shadow: 0 0 20px rgba(0,0,0,0.8); padding: 12px; font-size: 12px; z-index: 1500; display: none; font-family: 'Roboto', sans-serif; }
        .tooltip-title { color: var(--ruined-green); font-weight: bold; display: block; margin-bottom: 5px; font-family: 'Cinzel', serif; font-size: 14px; border-bottom: 1px solid #444; } .tooltip-stat { color: var(--power-yellow); display: block; margin-top: 5px; font-weight: bold; }

        .controls { height: 160px; border-top: 1px solid #444; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; padding-top: 20px; transition: opacity 0.5s; } .hidden-ui { opacity: 0; pointer-events: none; }
        .skills { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        .skill-btn { background: #111; border: 1px solid #444; color: #aaa; font-family: 'Cinzel', serif; cursor: pointer; position: relative; transition: 0.2s; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 8px; }
        .skill-btn:hover:not(:disabled) { border-color: var(--ruined-green); color: white; background: #1a1a1a; } .skill-btn:disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(100%); }
        .skill-name { font-weight: bold; font-size: 0.75rem; } .skill-cost { font-size: 0.65rem; color: #2ecc71; } .ult-btn { border-color: var(--ruined-green); color: var(--ruined-green); }
        .log-box { background: rgba(0,0,0,0.5); border: 1px solid #333; padding: 10px; font-size: 0.9rem; color: #ccc; font-family: 'Roboto', sans-serif; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .speech-bubble { position: absolute; top: -80px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 10px 15px; border-radius: 10px; font-family: 'Roboto', sans-serif; font-size: 12px; font-weight: bold; width: 220px; text-align: center; z-index: 150; opacity: 0; pointer-events: none; transition: 0.5s; border: 2px solid var(--ruined-green); } .speech-visible { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        .top-bar-controls { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
        .control-row { display: flex; gap: 10px; align-items: center; }
        .control-btn-ui, .volume-slider { background: rgba(0,0,0,0.5); color: white; border: 1px solid #555; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 14px; font-family: 'Roboto', sans-serif; transition: 0.2s; }
        .control-btn-ui:hover { background: var(--ruined-green); color: black; border-color: var(--ruined-green); }
        .volume-container { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 4px; border: 1px solid #555; }
        .volume-label { font-size: 12px; color: var(--ruined-green); }
        input[type=range] { width: 80px; cursor: pointer; }
        .back-btn { position: fixed; top: 20px; left: 20px; z-index: 200; color: var(--ruined-green); text-decoration: none; border: 1px solid var(--ruined-green); padding: 5px 15px; background: rgba(0,0,0,0.8); font-weight: bold; }

        .float-text { position: absolute; font-weight: bold; font-size: 24px; pointer-events: none; animation: floatUp 1.2s ease-out forwards; text-shadow: 2px 2px 0 #000; z-index: 100; font-family: 'Cinzel'; } @keyframes floatUp { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-80px); opacity: 0; } }
        .text-crit { color: var(--crit-color); font-size: 36px; } .text-heal { color: var(--heal-color); } .text-enemy-dmg { color: #e74c3c; } .text-special { color: #0ac8b9; } .text-weakness { color: #ff00ff; }
        #flash-effect { position: fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:50; }
        .ult-flash { animation: flash 1s linear; background: rgba(10, 200, 185, 0.5); } .stun-flash { animation: flash 0.5s linear; background: rgba(255, 255, 0, 0.3); } .void-flash { animation: flash 1s linear; background: rgba(160, 32, 240, 0.4); } @keyframes flash { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body>
    
    <a href="index.html" class="back-btn" id="btn-menu">‚Üê Menu</a>
    <div id="flash-effect"></div>
    
    <div id="inventory-frame">
        <div class="inv-slot" onclick="useInventoryItem('potion')" onmouseover="showTooltip(this, 'potion')" onmouseout="hideTooltip()">
            üß™ <span class="inv-count" id="count-potion">0</span>
        </div>
        <div class="inv-slot" onclick="useInventoryItem('elixir')" onmouseover="showTooltip(this, 'elixir')" onmouseout="hideTooltip()">
            ‚ö° <span class="inv-count" id="count-elixir">0</span>
        </div>
    </div>
    
    <div class="top-bar-controls">
        <div class="control-row">
            <button class="control-btn-ui" id="btn-restart" onclick="showRestartModal()">üîÑ Restart</button>
            <select class="control-btn-ui" id="lang-select" onchange="changeLanguage(this.value)">
                <option value="en">English</option>
                <option value="tr">T√ºrk√ße</option>
            </select>
        </div>
        <div class="volume-container">
            <span class="volume-label">üéµ Music</span>
            <input type="range" id="music-vol" min="0" max="1" step="0.05" value="0.15">
        </div>
        <div class="volume-container">
            <span class="volume-label">üîä SFX</span>
            <input type="range" id="sfx-vol" min="0" max="1" step="0.05" value="0.3">
        </div>
    </div>

    <audio id="bgMusic" loop preload="auto"><source src="" type="audio/mpeg"></audio>

    <div id="inv-tooltip"></div>

    <div id="restart-modal">
        <h3 id="restart-title">OYUNU SIFIRLA?</h3>
        <p id="restart-msg">Emin misin? T√ºm ilerleme silinecek.</p>
        <div class="modal-btn-container">
            <button id="btn-restart-confirm" class="modal-btn btn-confirm" onclick="confirmRestart()">EVET, SIFIRLA</button>
            <button id="btn-restart-cancel" class="modal-btn btn-cancel" onclick="cancelRestart()">ƒ∞PTAL</button>
        </div>
    </div>

    <div id="info-modal" class="info-modal">
        <h3 id="info-title">KARAKTER Bƒ∞LGƒ∞Sƒ∞</h3>
        <div id="info-content">...</div>
        <button class="info-close" onclick="closeInfo()">KAPAT</button>
    </div>

    <div id="shop-modal">
        <div class="shop-header">
            <h3 style="margin:0; color:var(--gold-color);" id="shop-title-text">RUINED SHOP</h3>
            <div>
                <button id="sell-mode-btn" class="control-btn-ui" onclick="toggleSellMode()">SELL MODE: OFF</button>
                <span id="shop-gold-display" style="margin-left:10px; font-weight:bold; color:var(--gold-color);">0 Gold</span>
            </div>
        </div>
        <div class="shop-grid" id="shop-container"></div>
        <button class="info-close" id="shop-close-btn" onclick="closeShop()">CLOSE</button>
    </div>

    <div class="game-wrapper">
        <div id="start-screen">
            <h1 style="color: #fff;" id="start-title-1">THE RUINED KING'S</h1>
            <h1 id="start-title-2">REVENGE</h1>
            <p style="color: #aaa; margin-top: 10px;" id="start-sub">"It is all... for her."</p>
            <button class="start-btn" onclick="startGame()" id="start-btn">START STORY</button>
        </div>

        <div id="cinematic-dialogue">
            <div class="dialogue-box">
                <div id="cinematic-text">...</div>
                <button id="cinematic-btn" onclick="nextDialogue()">NEXT</button>
            </div>
        </div>

        <div id="overlay" class="overlay-msg">
            <h2 id="overlay-title">VICTORY</h2>
            <p id="overlay-quote">"..."</p>
            <div id="level-up-text" style="color: yellow; margin-bottom: 15px; display:none;">LEVEL UP!</div>
            <div id="overlay-buttons" style="display:flex; justify-content:center; gap:10px;">
                <button class="start-btn" id="btn-open-shop" onclick="openShop()">SHOP</button>
                <button class="start-btn" id="next-btn" onclick="nextLevel()">CONTINUE</button>
            </div>
        </div>

        <div id="final-choice-overlay">
            <h2 style="color: #fff; margin-bottom: 30px;" id="choice-title">MAKE YOUR CHOICE</h2>
            <button class="choice-btn btn-attack" onclick="makeFinalChoice('attack')" id="btn-choice-attack">STRIKE HER DOWN</button>
            <button class="choice-btn btn-surrender" onclick="makeFinalChoice('surrender')" id="btn-choice-surrender">SURRENDER TO LOVE</button>
        </div>

        <div class="battle-scene">
            <div class="character-box" id="player-box">
                <button class="info-btn" onclick="showInfo('player')">i</button>
                <div class="speech-bubble" id="player-bubble">...</div>
                <div class="level-badge" id="player-lvl">1</div>
                <div class="gold-display"><span id="player-gold">0</span> ü™ô</div>
                <div id="equipped-container"></div>
                <img src="https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Viego_0.jpg" class="character-img viego-glow" id="player-img">
                <h2 style="color: var(--ruined-green);">VIEGO</h2>
                <div class="stat-bar hidden-ui" id="ui-hp-p"><div class="fill hp-fill" id="player-hp-bar" style="width: 100%;"></div><span class="bar-text" id="player-hp-text">150/150</span></div>
                <div class="stat-bar hidden-ui" style="border-color:#b7950b;" id="ui-mp-p"><div class="fill power-fill" id="player-power-bar" style="width: 0%;"></div><span class="bar-text" id="player-power-text" style="color:black;">0/100</span></div>
            </div>

            <h1 style="color: #555; font-size: 3rem;" id="vs-text">VS</h1>

            <div class="character-box" id="enemy-box">
                <button class="info-btn" onclick="showInfo('enemy')">i</button>
                <div class="speech-bubble" id="enemy-bubble">...</div>
                <div class="level-badge" id="enemy-lvl">1</div>
                <img src="" class="character-img enemy-glow" id="enemy-img">
                <h2 style="color: #d63031;" id="enemy-name">ENEMY</h2>
                <div class="stat-bar hidden-ui" id="ui-hp-e"><div class="shield-fill" id="enemy-shield-bar" style="width: 0%;"></div><div class="fill hp-fill" id="enemy-hp-bar" style="width: 100%;"></div><span class="bar-text" id="enemy-hp-text">100/100</span></div>
                <div id="boss-status" style="color: #ccc; font-size: 12px; margin-top: 5px;"></div>
            </div>
        </div>

        <div class="controls hidden-ui" id="combat-controls">
            <div class="skills">
                <button class="skill-btn" onclick="useSkill('basic')"><span class="skill-name" id="skill-basic-name">Blade of the King</span><span class="skill-cost" style="color:#fff;" id="skill-basic-cost">15 Dmg | +Power</span></button>
                <button class="skill-btn" id="btn-q" onclick="useSkill('q')"><span class="skill-name" id="skill-q-name">Blade of the Ruined King (Q)</span><span class="skill-cost" style="color:#2ecc71;" id="skill-q-cost">30 Dmg | 15 Power</span><span class="skill-sub" id="skill-q-desc">7% Enemy HP Steal</span></button>
                <button class="skill-btn" id="btn-w" onclick="useSkill('w')"><span class="skill-name" id="skill-w-name">Spectral Maw (W)</span><span class="skill-cost" id="skill-w-cost">40 Dmg | 25 Power</span><span class="cooldown-text" id="cd-w">Cooldown: 2</span></button>
                <button class="skill-btn ult-btn" id="btn-ult" onclick="useSkill('r')"><span class="skill-name" id="skill-r-name">HEARTBREAKER (R)</span><span class="skill-cost" id="skill-r-cost">~200 Dmg | SINGLE</span></button>
            </div>
            <div class="log-box" id="combat-log"></div>
        </div>
    </div>

<script>
    // --- WEBGL SHADER KODLARI ---
    const mistFragmentShader = `#version 300 es
    precision highp float;

    uniform float time;
    uniform vec2 vp;

    in vec2 uv;
    out vec4 fragColor;

    float rand(vec2 p) {
        return fract(sin(dot(p.xy, vec2(1., 300.))) * 43758.5453123);
    }

    float noise(vec2 p) {
        vec2 i = floor(p);
        vec2 f = fract(p);
        float a = rand(i);
        float b = rand(i + vec2(1.0, 0.0));
        float c = rand(i + vec2(0.0, 1.0));
        float d = rand(i + vec2(1.0, 1.0));
        vec2 u = f * f * (3.0 - 2.0 * f);
        return mix(a, b, u.x) + (c - a)* u.y * (1.0 - u.x) + (d - b) * u.x * u.y;
    }

    #define OCTAVES 4
    float fbm(vec2 p) {
        float value = 0.;
        float amplitude = .5;
        for (int i = 0; i < OCTAVES; i++) {
            value += amplitude * noise(p);
            p *= 2.2;
            amplitude *= .45;
        }
        return value;
    }

    void main() {
        vec2 p = uv.xy;
        p.x *= vp.x / vp.y;

        // "Etrafa daƒüƒ±lan" girdaplƒ± hareket i√ßin domain warping
        // Sabit bir y√∂n (y ekseni) yerine zamana baƒülƒ± dairesel ve kaotik deƒüi≈üim
        float t = time * 0.1;
        vec2 flow = vec2(sin(t * 0.5), cos(t * 0.3)) * 0.2;
        
        vec2 fast = (p + flow) * 3.5; // Scale d√º≈ü√ºr√ºlerek daha "duman" g√∂r√ºnt√ºs√º verildi
        
        float ns_a = fbm(fast + t);
        float ns_b = fbm(fast + ns_a - t * 0.5);
        float intensity = fbm(vec2(ns_a, ns_b));

        // Viego Renk Paleti (Koyu Siyah/Ye≈üil -> Parlak Mahvolmu≈ü Teal)
        vec3 darkMist = vec3(0.02, 0.05, 0.05); // √áok koyu zemin
        vec3 ruinedTeal = vec3(0.04, 0.78, 0.72); // Viego ye≈üili
        
        // Karƒ±≈üƒ±m: Siyah sisin i√ßinden parlayan ye≈üil ruhlar gibi
        vec3 color = mix(darkMist, ruinedTeal, intensity * intensity * 0.8);

        // Alpha kanalƒ±: Sadece sisin yoƒüun olduƒüu yerler g√∂r√ºns√ºn, arkadaki splash art √∂lmesin
        float alpha = smoothstep(0.2, 0.9, intensity);

        fragColor = vec4(color, alpha);
    }
    `;

    class WebGLHandler {
        vertexShaderSource = `#version 300 es
            precision mediump float;
            const vec2 positions[6] = vec2[6](vec2(-1.0, -1.0), vec2(1.0, -1.0), vec2(-1.0, 1.0), vec2(-1.0, 1.0), vec2(1.0, -1.0), vec2(1.0, 1.0));
            out vec2 uv;
            void main() {
                uv = positions[gl_VertexID];
                gl_Position = vec4(positions[gl_VertexID], 0.0, 1.0);
            }`;

        constructor(canvas, fragmentShaderSource) {
            this.cn = canvas;
            this.gl = canvas.getContext("webgl2", { alpha: true, premultipliedAlpha: false }); // Alpha desteƒüi a√ßƒ±ldƒ±
            this.startTime = Date.now();
            this.resize();
            window.addEventListener("resize", () => this.resize());
            this.program = this.gl.createProgram();
            this.compileShader(this.vertexShaderSource, this.gl.VERTEX_SHADER);
            this.compileShader(fragmentShaderSource, this.gl.FRAGMENT_SHADER);
            this.gl.linkProgram(this.program);
            this.gl.useProgram(this.program);
            this.timeLocation = this.gl.getUniformLocation(this.program, "time");
            this.resolutionLocation = this.gl.getUniformLocation(this.program, "vp");
            this.render();
        }

        resize() {
            this.cn.width = window.innerWidth;
            this.cn.height = window.innerHeight;
            this.gl.viewport(0, 0, this.cn.width, this.cn.height);
        }

        compileShader(source, type) {
            const shader = this.gl.createShader(type);
            this.gl.shaderSource(shader, source);
            this.gl.compileShader(shader);
            if (!this.gl.getShaderParameter(shader, this.gl.COMPILE_STATUS)) {
                console.error(this.gl.getShaderInfoLog(shader));
                this.gl.deleteShader(shader);
                return null;
            }
            return this.gl.attachShader(this.program, shader);
        }

        render = () => {
            this.gl.uniform1f(this.timeLocation, (Date.now() - this.startTime) / 1000);
            this.gl.uniform2fv(this.resolutionLocation, [this.cn.width, this.cn.height]);
            this.gl.drawArrays(this.gl.TRIANGLES, 0, 6);
            window.requestAnimationFrame(this.render);
        };
    }

    // Canvas'ƒ± olu≈ütur ve ba≈ülat
    const mistCanvas = document.body.appendChild(document.createElement("canvas"));
    mistCanvas.id = "mist-canvas";
    const webGL = new WebGLHandler(mistCanvas, mistFragmentShader);


    // --- OYUN JS KODLARI (MEVCUT KODLAR) ---
    let musicVolume = 0.15; let sfxVolume = 0.3;
    const bgMusic = document.getElementById('bgMusic');
    const musicSlider = document.getElementById('music-vol');
    const sfxSlider = document.getElementById('sfx-vol');

    function showRestartModal() { document.getElementById('restart-modal').style.display = 'block'; }
    function confirmRestart() { localStorage.removeItem('viegoRPG_save'); location.reload(); }
    function cancelRestart() { document.getElementById('restart-modal').style.display = 'none'; }

    function showDefeatScreen() {
        const overlay = document.getElementById('overlay');
        document.getElementById('overlay-title').innerText = currentLang === 'en' ? "DEFEAT" : "YENƒ∞LGƒ∞";
        document.getElementById('overlay-title').style.color = "#c0392b";
        document.getElementById('overlay-quote').innerText = currentLang === 'en' ? "The Mist fades..." : "Sis daƒüƒ±lƒ±yor...";
        document.getElementById('level-up-text').style.display = 'none';
        const btnContainer = document.getElementById('overlay-buttons');
        btnContainer.innerHTML = `<button class="start-btn" onclick="confirmRestart()" style="border-color:#c0392b; color:#c0392b;">${currentLang === 'en' ? "TRY AGAIN" : "TEKRAR DENE"}</button>`;
        overlay.style.display = 'flex';
    }

    function saveSettings() { localStorage.setItem('viegoRPG_settings', JSON.stringify({ mVol: musicVolume, sVol: sfxVolume })); }
    function loadSettings() {
        const savedSet = localStorage.getItem('viegoRPG_settings');
        if (savedSet) {
            const data = JSON.parse(savedSet); musicVolume = data.mVol; sfxVolume = data.sVol;
            musicSlider.value = musicVolume; sfxSlider.value = sfxVolume; bgMusic.volume = musicVolume;
        }
    }
    musicSlider.addEventListener('input', (e) => { musicVolume = e.target.value; bgMusic.volume = musicVolume; saveSettings(); });
    sfxSlider.addEventListener('input', (e) => { sfxVolume = e.target.value; saveSettings(); });

    const sounds = { basic1: new Audio('BasicAA_1.wav'), basic2: new Audio('BasicAA_2.wav'), w: new Audio('W_Skill.wav'), q: new Audio(), r: new Audio() };
    function playSkillSound(type) { try { let s = null; if(type==='basic') s = Math.random()>0.5 ? sounds.basic1 : sounds.basic2; else if(type==='w') s = sounds.w; else if(type==='q') s = sounds.q; else if(type==='r') s = sounds.r; if(s) { s.volume = sfxVolume; s.currentTime=0; s.play(); } } catch(e){} }

    let player = { name: "Viego", level: 1, maxHp: 150, hp: 150, maxPower: 100, power: 0, ultUsed: false, critChance: 0.2, nextHitCrit: false, wCooldown: 0, gold: 0, baseDmgBonus: 0, potions: 0, elixirs: 0, armor: 0, ownedPassives: [] };
    let currentEnemyIndex = 0;

    function saveGame() { localStorage.setItem('viegoRPG_save', JSON.stringify({ player: player, enemyIndex: currentEnemyIndex })); }
    function loadGame() {
        const saved = localStorage.getItem('viegoRPG_save');
        if (saved) {
            const data = JSON.parse(saved); player = data.player; currentEnemyIndex = data.enemyIndex;
            if (!player.ownedPassives) player.ownedPassives = []; if (player.items) delete player.items; 
            recalculateStats(); updateInventoryUI(); updateEquippedUI(); updateUI();
        }
    }
    function recalculateStats() {
        player.baseDmgBonus = player.ownedPassives.includes('sword') ? 40 : 0;
        player.armor = player.ownedPassives.includes('armor') ? 20 : 0;
        player.critChance = 0.2 + (player.ownedPassives.includes('cloak') ? 0.15 : 0);
    }

    const shopItems = [
        { id: 'potion', basePrice: 50, type: 'consumable', icon: 'üß™', sellable: true },
        { id: 'elixir', basePrice: 50, type: 'consumable', icon: '‚ö°', sellable: true },
        { id: 'sword', basePrice: 250, type: 'passive', icon: '‚öîÔ∏è', sellable: true },
        { id: 'armor', basePrice: 250, type: 'passive', icon: 'üõ°Ô∏è', sellable: true },
        { id: 'cloak', basePrice: 250, type: 'passive', icon: 'üß•', sellable: true },
        { id: 'vampScepter', basePrice: 400, type: 'passive', icon: 'ü©∏', sellable: true },
        { id: 'thornmail', basePrice: 500, type: 'passive', icon: 'üåµ', sellable: true }
    ];

    let bossState = { isPlayerStunned: false, threshStacks: 0, threshVulnerable: false, belvethForm: 1, mordeRealmTriggered: false, mordeRealmActive: false, turnCount: 0, leblancClone: false, leblancHidden: false, leblancBuffTurns: 0 };
    const musicTracks = { tier1: "Tier1.mp3", tier2: "Tier2.mp3", tier3: "tier3.mp3", morde: "morde.mp3", isolde: "isolde.mp3", thresh: "thresh.mp3", leblanc: "leblanc.mp3" };
    
    const enemiesBase = [
        { id: "gangplank", level: 2, maxHp: 200, hp: 200, damage: 15, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Gangplank_0.jpg" },
        { id: "yorick", level: 4, maxHp: 250, hp: 250, damage: 18, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Yorick_0.jpg" },
        { id: "akshan", level: 6, maxHp: 300, hp: 300, damage: 22, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Akshan_0.jpg" },
        { id: "gwen", level: 8, maxHp: 350, hp: 350, damage: 25, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Gwen_0.jpg" },
        { id: "lucian_senna", level: 10, maxHp: 500, hp: 500, damage: 35, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Lucian_0.jpg" },
        { id: "maokai", level: 12, maxHp: 600, hp: 600, damage: 30, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Maokai_0.jpg" },
        { id: "elise", level: 14, maxHp: 650, hp: 650, damage: 35, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Elise_0.jpg" },
        { id: "vladimir", level: 16, maxHp: 700, hp: 700, damage: 38, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Vladimir_0.jpg" },
        { id: "hecarim", level: 18, maxHp: 750, hp: 750, damage: 42, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Hecarim_0.jpg" },
        { id: "illaoi", level: 20, maxHp: 800, hp: 800, damage: 40, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Illaoi_0.jpg" },
        { id: "kalista", level: 22, maxHp: 850, hp: 850, damage: 45, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Kalista_0.jpg" },
        { id: "ledros", level: 24, maxHp: 950, hp: 950, damage: 50, img: "https://wiki.leagueoflegends.com/en-us/images/01SI033-full.png?b1aad" },
        { id: "leblanc", level: 26, maxHp: 1000, hp: 1000, damage: 60, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Leblanc_0.jpg" },
        { id: "thresh", level: 28, maxHp: 1050, hp: 1050, damage: 65, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Thresh_0.jpg" }, 
        { id: "belveth", level: 30, maxHp: 1400, hp: 1400, damage: 75, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Belveth_0.jpg" },
        { id: "mordekaiser", level: 35, maxHp: 2000, hp: 2000, damage: 90, img: "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Mordekaiser_0.jpg" }
    ];

    const mechanicsInfo = {
        player: `<span class='info-weak'>Q - Kralƒ±n Kƒ±lƒ±cƒ±:</span> Rakibin canƒ±ndan √ßalar (%7).<br><br><span class='info-weak'>W - Hortlaƒüƒ±n Pen√ßesi:</span> Sonraki saldƒ±rƒ± KRƒ∞Tƒ∞K olur. Thresh gardƒ±nƒ± kƒ±rar!<br><br><span class='info-strong'>R - ULTƒ∞:</span> Eksik cana g√∂re vurur. W+R kombosu kritik vurur!`,
        thresh: `<span class='info-strong'>G√ú√á:</span> Her tur zƒ±rh ve hasar kazanƒ±r. 12 Ruh'ta bir STUN atar. Blokladƒ±ƒüƒ± hasarƒ±n %5'i ile iyile≈üir.<br><br><span class='info-weak'>ZAYIFLIK:</span> Viego'nun <b>W (Hortlaƒüƒ±n Pen√ßesi)</b> yeteneƒüi gardƒ±nƒ± kƒ±rar ve sonraki hasarƒ± 2 katƒ±na √ßƒ±karƒ±r.`,
        leblanc: `<span class='info-strong'>G√ú√á:</span> Hilekar! %40 ≈üansla b√ºy√ºy√º taklit eder (√áift vuru≈ü). Canƒ± azaldƒ±ƒüƒ±nda G√ñR√úNMEZ olur ve sonraki 2 tur <b>%100 √áƒ∞FT VURU≈û</b> yapar.<br><br><span class='info-weak'>ZAYIFLIK:</span> Canƒ± azdƒ±r. Kopyasƒ±na vurmamaya dikkat et.`,
        belveth: `<span class='info-strong'>G√ú√á:</span> Asla tek seferde √∂lmez. Canƒ± bittiƒüinde GER√áEK FORMUNA d√∂n√º≈ü√ºr ve canƒ±nƒ± yeniler.<br><br><span class='info-weak'>ZAYIFLIK:</span> ƒ∞lk formu zayƒ±ftƒ±r.`,
        mordekaiser: `<span class='info-strong'>G√ú√á:</span> Canƒ± %35 altƒ±na inince √ñL√úLER ALEMƒ∞NE √ßeker (Statlarƒ± artar).<br><br><span class='info-weak'>ZAYIFLIK:</span> Sadece bir kez olur.`,
        default: `<span class='info-strong'>DURUM:</span> Standart rakip.<br><br><span class='info-weak'>ƒ∞PUCU:</span> Q ile canƒ±nƒ± y√ºksek tut, W+R ile bitir.`
    };

    let currentLang = 'en'; let t = {};
    const translations = {
        en: { title1: "THE RUINED KING'S", title2: "REVENGE", sub: "\"It is all... for her.\"", startBtn: "START STORY", victory: "VICTORY", levelUp: "LEVEL UP!", continue: "CONTINUE", defeat: "DEFEAT...", skillBasic: "Blade of the King", skillQ: "Blade of the Ruined King (Q)", skillQDesc: "7% Enemy HP Steal", skillW: "Spectral Maw (W)", skillR: "HEARTBREAKER (R)", finalChoiceTitle: "MAKE YOUR CHOICE", choiceAttack: "STRIKE HER DOWN", choiceSurrender: "SURRENDER TO LOVE", menu: "‚Üê Menu", restart: "üîÑ Restart",
            restartTitle: "RESTART GAME?", restartMsg: "Are you sure? All progress will be lost.", restartConfirm: "YES, RESTART", restartCancel: "CANCEL",
            logViegoBasic: "Viego strikes!", logViegoQ: "Viego used Q!", logViegoW: "Viego prepared W!", logViegoR: "VIEGO ULTI!", logCrit: " (CRIT!)", logDamage: " damage.", logEnemyAtk: " attacked! You took ", logNoPower: "Not enough Power!", logCooldown: "Cooldown!", logUltUsed: "Ulti used!", logStart: "Battle Start!", logPotion: "Used Potion (+HP)", logPotionErr: "No Potions!", logElixir: "Used Elixir (+40 Power)", logElixirErr: "No Elixirs!",
            bossLogs: { stunned: "YOU ARE STUNNED! CANNOT ACT.", threshStack: "Thresh absorbs souls!", leblancMimic: "LeBlanc MIMICS spell!", belvethTransform: "TRUE FORM REVEALED!", mordeRealm: "DEATH REALM!", leblancClone: "LeBlanc vanishes!", decoy: "DECOY!", leblancEnraged: "LeBlanc returns empowered! (100% Mimic)" },
            isolde: { intro: ["Viego: \"Isolde...\"", "Isolde: \"Let me go...\""], endingAttack: ["Viego: \"If I cannot have you...\"", "System: The End."], endingSurrender: ["Viego: \"I am yours.\"", "*Fade*"] },
            shop: { title: "RUINED SHOP", gold: "Gold", close: "CLOSE", btnShop: "SHOP", buy: "BUY", owned: "OWNED", sellModeOn: "SELL MODE: ON", sellModeOff: "SELL MODE: OFF", sell: "SELL",
                items: {
                    potion: { name: "Mist Potion", desc: "Restores 10% Missing HP", stat: "Heal" },
                    elixir: { name: "Wrath Elixir", desc: "Restores Power", stat: "+40 PWR" },
                    sword: { name: "Ruined Blade", desc: "PASSIVE: +40 Base Damage.", stat: "Damage" },
                    armor: { name: "Spectral Armor", desc: "PASSIVE: +20% Damage Reduction.", stat: "Armor" },
                    cloak: { name: "Crit Cloak", desc: "PASSIVE: +15% Crit Chance.", stat: "Crit" },
                    vampScepter: { name: "Vampiric Scepter", desc: "PASSIVE: Basic attacks heal 10 HP.", stat: "Lifesteal" },
                    thornmail: { name: "Thornmail", desc: "PASSIVE: Reflects 15 magic damage when hit.", stat: "Reflect" }
                }
            },
            enemies: [
                { id: "gangplank", name: "Gangplank", win: "Viego: \"A pirate cannot stop a King.\"", intro: ["Gangplank: \"Get off my ship, ghost! This city is mine!\"", "Viego: \"Everything the mist touches belongs to me.\"", "Gangplank: \"I'll carve your heart out!\"", "Viego: \"I have no heart left to break.\""], quotes: ["Barrel!", "Burn!"] },
                { id: "yorick", name: "Yorick", win: "Viego: \"Return to your grave, Monk.\"", intro: ["Yorick: \"The Mist must be purged. You must be stopped.\"", "Viego: \"The Mist IS me. You fight the inevitable.\"", "Yorick: \"I fight for the living. You fight for a corpse.\""], quotes: ["Join the grave."] },
                { id: "akshan", name: "Akshan", win: "Viego: \"No absolver can save you.\"", intro: ["Akshan: \"Pretty face, ugly soul. Let's fix that.\"", "Viego: \"You are an annoying insect.\"", "Akshan: \"And you're a king with a temper tantrum.\""], quotes: ["Boom!"] },
                { id: "gwen", name: "Gwen", win: "Viego: \"You are nothing but a doll.\"", intro: ["Gwen: \"I remember her smile... She wouldn't want this!\"", "Viego: \"Silence! You are a mockery of her memory!\"", "Gwen: \"I will cut the mist away from you!\""], quotes: ["Snip snip!"] },
                { id: "lucian_senna", name: "Lucian & Senna", win: "Viego: \"Your love is weak compared to mine.\"", intro: ["Lucian: \"It ends here, Viego! For everyone you've hurt!\"", "Viego: \"You saved your wife, Lucian. Why can't I have mine?!\"", "Senna: \"Because she is gone! You are chasing a ghost!\""], quotes: ["For the Light!", "Together!"] },
                { id: "maokai", name: "Maokai", win: "Viego: \"Burn with the Isles.\"", intro: ["Maokai: \"You poisoned the waters of life!\"", "Viego: \"I made them eternal. You should thank me.\"", "Maokai: \"I will crush you into the dirt!\""], quotes: ["Nature's wrath."] },
                { id: "elise", name: "Elise", win: "Viego: \"Go back to your spider god.\"", intro: ["Elise: \"My god is hungry for a King's soul.\"", "Viego: \"I am not food. I am death incarnate.\"", "Elise: \"We shall see about that.\""], quotes: ["Closer..."] },
                { id: "vladimir", name: "Vladimir", win: "Viego: \"Your blood magic is useless here.\"", intro: ["Vladimir: \"Ah, Viego. Still chasing fairytales?\"", "Viego: \"Watch your tongue, uncle. Or I will rip it out.\"", "Vladimir: \"So dramatic. Let's paint the floor red.\""], quotes: ["Delicious."] },
                { id: "hecarim", name: "Hecarim", win: "Viego: \"The war is over, rider.\"", intro: ["Hecarim: \"War! Eternal war! Lead us, my King!\"", "Viego: \"You are a blunt instrument, Hecarim. Obey me.\"", "Hecarim: \"I only obey the charge!\""], quotes: ["Trample them!"] },
                { id: "illaoi", name: "Illaoi", win: "Viego: \"Your god has no power here.\"", intro: ["Illaoi: \"You are stagnant. You are stuck in the past.\"", "Viego: \"My love is timeless!\"", "Illaoi: \"Motion is life. You are dead inside.\""], quotes: ["Motion is life."] },
                { id: "kalista", name: "Kalista", win: "Viego: \"Betrayer! You let her die!\"", intro: ["Kalista: \"Viego... please. End this madness.\"", "Viego: \"You swore to protect me! You failed her!\"", "Kalista: \"I swore to the truth. You are lost.\""], quotes: ["Vengeance!"] },
                { id: "ledros", name: "Ledros", win: "Viego: \"Rest now, old friend.\"", intro: ["Ledros: \"I have tried to save you for centuries, my King.\"", "Viego: \"Then why do you stand in my way, Ledros?\"", "Ledros: \"Because the man I served is gone. Only the monster remains.\""], quotes: ["I cannot fall."] },
                { id: "leblanc", name: "LeBlanc", win: "Viego: \"Deceiver. Your games bore me.\"", intro: ["Viego: \"Where is she?! I know you know something!\"", "LeBlanc: \"I know many things. But do you want the truth?\"", "Viego: \"Isolde'yi istiyorum! Onu bana ver!\"", "LeBlanc: \"Yakala beni, mahvolmu≈ü √ßocuk.\""], quotes: ["Smoke and mirrors."] },
                { id: "thresh", name: "Thresh", win: "Viego: \"Get back in your lantern, wretch.\"", intro: ["Thresh: \"Oh, the exquisite agony you spread.\"", "Viego: \"Do not mock me, Thresh. You are but a servant.\"", "Thresh: \"Servants eventually become masters, don't they?\""], quotes: ["Scream."] },
                { id: "belveth", name: "Bel'Veth", win: "Viego: \"Love conquered the Void.\"", intro: ["Bel'Veth: \"I will consume your world, King.\"", "Viego: \"My world is Isolde. You cannot touch her.\"", "Bel'Veth: \"I will remake everything. Including your grief.\""], quotes: ["The end."] },
                { id: "mordekaiser", name: "Mordekaiser", win: "Viego: \"Death has a new King now.\"", intro: ["Mordekaiser: \"Iron stands eternal. Your mist is weak.\"", "Viego: \"I will rust your armor and break your will!\"", "Mordekaiser: \"You are a child playing with souls. I AM DEATH.\""], quotes: ["Crumble."] }
            ]
        },
        tr: { title1: "MAHVOLMU≈û KRAL'IN", title2: "ƒ∞NTƒ∞KAMI", sub: "\"Hepsi... Onun i√ßin.\"", startBtn: "Hƒ∞KAYEYE BA≈ûLA", victory: "ZAFER", levelUp: "SEVƒ∞YE ATLADIN!", continue: "DEVAM ET", defeat: "KAYBETTƒ∞N...", skillBasic: "Kralƒ±n Kƒ±lƒ±cƒ±", skillQ: "M. Kralƒ±n Kƒ±lƒ±cƒ± (Q)", skillQDesc: "%7 Rakip Can √áalma", skillW: "Hortlakƒ±n Pen√ßesi (W)", skillR: "KALP KIRAN (R)", finalChoiceTitle: "SE√áƒ∞Mƒ∞Nƒ∞ YAP", choiceAttack: "ONU √ñLD√úR", choiceSurrender: "TESLƒ∞M OL", menu: "‚Üê Men√º", restart: "üîÑ Yeniden Ba≈üla",
            restartTitle: "OYUNU SIFIRLA?", restartMsg: "Emin misin? T√ºm ilerleme silinecek.", restartConfirm: "EVET, SIFIRLA", restartCancel: "ƒ∞PTAL",
            logViegoBasic: "Viego vurdu!", logViegoQ: "Viego Q kullandƒ±!", logViegoW: "Viego W hazƒ±rladƒ±!", logViegoR: "VIEGO ULTƒ∞ ATTI!", logCrit: " (KRƒ∞Tƒ∞K!)", logDamage: " hasar.", logEnemyAtk: " saldƒ±rdƒ±! Aldƒ±ƒüƒ±n hasar: ", logNoPower: "G√º√ß Yetersiz!", logCooldown: "Bekleme S√ºresi!", logUltUsed: "Ulti kullanƒ±ldƒ±!", logStart: "Sava≈ü Ba≈üladƒ±!", logPotion: "Sis ƒ∞ksiri i√ßildi (+%10 Can)", logPotionErr: "ƒ∞ksirin yok!", logElixir: "√ñfke ƒ∞ksiri i√ßildi (+40 G√º√ß)", logElixirErr: "ƒ∞ksirin yok!",
            bossLogs: { stunned: "SERSEMLEDƒ∞N!", threshStack: "Thresh ruh topladƒ±!", leblancMimic: "LeBlanc TAKLƒ∞T ETTƒ∞!", belvethTransform: "GER√áEK FORM!", mordeRealm: "√ñL√úLER ALEMƒ∞!", leblancClone: "LeBlanc g√∂r√ºnmez oldu!", decoy: "KOPYA!", leblancEnraged: "LeBlanc g√º√ßlendi! (Kesin Taklit)" },
            isolde: { intro: ["Viego: \"Isolde... A≈ükƒ±m... Senin i√ßin d√ºnyayƒ± yaktƒ±m.\"", "Isolde: \"Viego... neye d√∂n√º≈üt√ºƒü√ºne bir bak. Bu a≈ük deƒüil.\"", "Viego: \"BU A≈ûK! Her ≈üeyi senin y√ºz√ºn√º tekrar g√∂rmek i√ßin yaptƒ±m!\"", "Isolde: \"Sen bir canavarsƒ±n Kralƒ±m. Bƒ±rak gideyim. D√ºnya iyile≈üsin.\"", "Viego: \"ASLA! Seni bir daha asla kaybetmeyeceƒüim!\""], endingAttack: ["Viego: \"Eƒüer sana sahip olamƒ±yorsam... kimse olamaz.\"", "Isolde: \"Viego... nihayet... huzur...\"", "Sistem: Tek a≈ükƒ±nƒ± kendi ellerinle yok ettin. Sis daƒüƒ±ldƒ±, geriye bo≈ü bir taht kaldƒ±."], endingSurrender: ["Viego: \"Ben... Seni incitemem. Sonsuza dek seninim.\"", "Isolde: \"Ah, Viego. Benim zavallƒ±, aptal Kralƒ±m.\"", "*Viego kƒ±lƒ±cƒ±nƒ± yere atar. Isolde g√∂zlerinde ya≈ülarla kƒ±lƒ±cƒ± alƒ±r.*", "Isolde: \"Uyu artƒ±k sevgilim. Kabus bitti.\"", "*Isolde kƒ±lƒ±cƒ± Viego'nun kalbine saplar. Birlikte sisin i√ßinde kaybolurlar.*"] },
            shop: { title: "MAHVOLMU≈û MAƒûAZA", gold: "Altƒ±n", close: "KAPAT", btnShop: "MAƒûAZA", buy: "SATIN AL", owned: "SAHƒ∞PSƒ∞N", sellModeOn: "SATI≈û MODU: A√áIK", sellModeOff: "SATI≈û MODU: KAPALI", sell: "SAT",
                items: {
                    potion: { name: "Sis ƒ∞ksiri", desc: "%10 Eksik Can Yeniler", stat: "ƒ∞yile≈üme" },
                    elixir: { name: "√ñfke ƒ∞ksiri", desc: "G√º√ß Yeniler", stat: "+40 G√ú√á" },
                    sword: { name: "Mahvolmu≈ü Kƒ±lƒ±√ß", desc: "PASƒ∞F: +40 Taban Hasar.", stat: "Hasar" },
                    armor: { name: "Hayalet Zƒ±rh", desc: "PASƒ∞F: %20 Hasar Azaltma.", stat: "Zƒ±rh" },
                    cloak: { name: "Kritik Pelerini", desc: "PASƒ∞F: +%15 Kritik ≈ûansƒ±.", stat: "Kritik" },
                    vampScepter: { name: "Vampir Asasƒ±", desc: "PASƒ∞F: D√ºz vuru≈ülar 10 Can iyile≈ütirir.", stat: "Can √áalma" },
                    thornmail: { name: "√áivili Zƒ±rh", desc: "PASƒ∞F: Hasar alƒ±nca 15 b√ºy√º hasarƒ± yansƒ±tƒ±r.", stat: "Yansƒ±tma" }
                }
            },
            enemies: [
                { id: "gangplank", name: "Gangplank", win: "Viego: \"Burasƒ± benim ≈üehrim.\"", intro: ["Gangplank: \"Gemimden defol hayalet! Bu ≈üehir benim!\"", "Viego: \"Sisin dokunduƒüu her ≈üey bana aittir.\"", "Gangplank: \"Kalbini s√∂k√ºp alacaƒüƒ±m!\"", "Viego: \"Kƒ±rƒ±lacak bir kalbim kalmadƒ±.\""], quotes: ["Fƒ±√ßƒ±!", "Yak onlarƒ±!"] },
                { id: "yorick", name: "Yorick", win: "Viego: \"Mezarƒ±nƒ± kaz.\"", intro: ["Yorick: \"Sis temizlenmeli. Durdurulmalƒ±sƒ±n.\"", "Viego: \"Sis BENƒ∞M. Ka√ßƒ±nƒ±lmaz olandan ka√ßamazsƒ±n.\"", "Yorick: \"Ben ya≈üayanlar i√ßin sava≈üƒ±yorum. Sen bir ceset i√ßin.\""], quotes: ["Mezara gir."] },
                { id: "akshan", name: "Akshan", win: "Viego: \"Dirili≈ü yok.\"", intro: ["Akshan: \"G√ºzel y√ºz, √ßirkin ruh. Hadi d√ºzeltelim.\"", "Viego: \"Sen sadece can sƒ±kƒ±cƒ± bir b√∂ceksin.\"", "Akshan: \"Sen de mƒ±zmƒ±z bir kralsƒ±n.\""], quotes: ["Bum!"] },
                { id: "gwen", name: "Gwen", win: "Viego: \"Sadece bir oyuncaksƒ±n.\"", intro: ["Gwen: \"O'nun g√ºl√º≈ü√ºn√º hatƒ±rlƒ±yorum... Bunu istemezdi!\"", "Viego: \"Kes sesini! Sen sadece onun g√∂lgesisin!\"", "Gwen: \"Seni durduracaƒüƒ±m ve herkesi kurtaracaƒüƒ±m!\""], quotes: ["Kesip bi√ßerim!"] },
                { id: "lucian_senna", name: "Lucian & Senna", win: "Viego: \"A≈ükƒ±nƒ±z zayƒ±f.\"", intro: ["Lucian: \"Burada bitiyor Viego! ƒ∞ncittiƒüin herkes i√ßin!\"", "Viego: \"Sen karƒ±nƒ± kurtardƒ±n Lucian. Ben neden kurtaramayayƒ±m?!\"", "Senna: \"√á√ºnk√º o gitti Viego! Bir hayali kovalƒ±yorsun!\""], quotes: ["I≈üƒ±k adƒ±na!", "Birlikte!"] },
                { id: "maokai", name: "Maokai", win: "Viego: \"Adalarla birlikte yan.\"", intro: ["Maokai: \"Ya≈üam sularƒ±nƒ± zehirledin!\"", "Viego: \"Onlarƒ± sonsuz kƒ±ldƒ±m. Bana te≈üekk√ºr etmelisin.\"", "Maokai: \"Seni topraƒüa g√∂meceƒüim!\""], quotes: ["Doƒüa affetmez."] },
                { id: "elise", name: "Elise", win: "Viego: \"√ñr√ºmcek tanrƒ±na d√∂n.\"", intro: ["Elise: \"Tanrƒ±m bir kralƒ±n ruhuna a√ß.\"", "Viego: \"Ben yemek deƒüilim. Ben √∂l√ºm√ºn kendisiyim.\"", "Elise: \"G√∂receƒüiz.\""], quotes: ["Yakla≈ü..."] },
                { id: "vladimir", name: "Vladimir", win: "Viego: \"Kanƒ±n bana ait amca.\"", intro: ["Vladimir: \"Ah, Viego. Hala masallarƒ±n pe≈üinde misin?\"", "Viego: \"S√∂zlerine dikkat et amca. Yoksa dilini koparƒ±rƒ±m.\"", "Vladimir: \"√áok dramatiksin. Hadi yeri kƒ±rmƒ±zƒ±ya boyayalƒ±m.\""], quotes: ["Kanƒ±n kokusu..."] },
                { id: "hecarim", name: "Hecarim", win: "Viego: \"Sava≈ü bitti s√ºvari.\"", intro: ["Hecarim: \"Sava≈ü! Sonsuz sava≈ü! Bize liderlik et Kralƒ±m!\"", "Viego: \"Sen sadece k√∂r bir silahsƒ±n Hecarim. ƒ∞taat et.\"", "Hecarim: \"Ben sadece katliama itaat ederim!\""], quotes: ["Ezip ge√ßin!"] },
                { id: "illaoi", name: "Illaoi", win: "Viego: \"Tanrƒ±n sessiz kaldƒ±.\"", intro: ["Illaoi: \"Sen durgunsun. Ge√ßmi≈üe saplanmƒ±≈üsƒ±n.\"", "Viego: \"A≈ükƒ±m zamansƒ±zdƒ±r!\"", "Illaoi: \"Hareket hayattƒ±r. Sen i√ßten √∂l√ºs√ºn.\""], quotes: ["Hareket hayattƒ±r."] },
                { id: "kalista", name: "Kalista", win: "Viego: \"Hain! Onu √∂l√ºme terk ettin!\"", intro: ["Kalista: \"Viego... yalvarƒ±rƒ±m. Bu deliliƒüe son ver.\"", "Viego: \"Beni korumaya yemin etmi≈ütin! Onu kurtaramadƒ±n!\"", "Kalista: \"Ben ger√ßeƒüe yemin ettim. Sen kayboldun.\""], quotes: ["ƒ∞ntikam!"] },
                { id: "ledros", name: "Ledros", win: "Viego: \"Uyu artƒ±k eski dostum.\"", intro: ["Ledros: \"Y√ºzyƒ±llardƒ±r seni kurtarmaya √ßalƒ±≈ütƒ±m Kralƒ±m.\"", "Viego: \"√ñyleyse neden yolumdasƒ±n Ledros?\"", "Ledros: \"√á√ºnk√º hizmet ettiƒüim adam √∂ld√º. Geriye sadece canavar kaldƒ±.\""], quotes: ["D√º≈üemem."] },
                { id: "leblanc", name: "LeBlanc", win: "Viego: \"Yalanlarƒ±n bitti, Hilekar.\"", intro: ["Viego: \"O nerede?! Bir ≈üeyler bildiƒüini biliyorum!\"", "LeBlanc: \"√áok ≈üey biliyorum. Ama ger√ßeƒüi kaldƒ±rabilir misin?\"", "Viego: \"Isolde'yi istiyorum! Onu bana ver!\"", "LeBlanc: \"Yakala beni, mahvolmu≈ü √ßocuk.\""], quotes: ["G√∂z yanƒ±lmasƒ±."] },
                { id: "thresh", name: "Thresh", win: "Viego: \"Fenerine geri d√∂n.\"", intro: ["Thresh: \"Yaydƒ±gƒ±n bu acƒ±... Ne kadar lezzetli.\"", "Viego: \"Benimle alay etme Thresh. Sen sadece bir hizmetkarsƒ±n.\"", "Thresh: \"Hizmetkarlar sonunda efendi olur, deƒüil mi?\""], quotes: ["√áƒ±ƒülƒ±k at."] },
                { id: "belveth", name: "Bel'Veth", win: "Viego: \"A≈ük Hi√ßliƒüi yendi.\"", intro: ["Bel'Veth: \"D√ºnyanƒ± t√ºketeceƒüim.\"", "Viego: \"Benim d√ºnyam Isolde.\""], quotes: ["Sonunuz geldi."] },
                { id: "mordekaiser", name: "Mordekaiser", win: "Viego: \"√ñl√ºm√ºn yeni Kralƒ± var.\"", intro: ["Mordekaiser: \"Demir ebedidir.\"", "Viego: \"Ben Mahvolmu≈ü Kralƒ±m!\""], quotes: ["Yƒ±kƒ±l."] }
            ]
        }
    };

    let turn = "player"; 
    let dialogueIndex = 0; let currentDialogues = []; let enemyTimeout = null; let isIsoldeScene = false; let currentTrack = "";
    let isSellMode = false;

    function changeMusic(trackName) {
        if (currentTrack === trackName) return; currentTrack = trackName;
        bgMusic.src = musicTracks[trackName]; bgMusic.volume = musicVolume;
        bgMusic.play().catch(e => {}); 
    }

    function changeLanguage(lang) {
        currentLang = lang; t = translations[lang]; localStorage.setItem('rpgLang', lang);
        document.getElementById('start-title-1').innerText = t.title1; document.getElementById('start-title-2').innerText = t.title2; document.getElementById('start-sub').innerText = t.sub; document.getElementById('start-btn').innerText = t.startBtn; document.getElementById('btn-menu').innerText = t.menu;
        document.getElementById('overlay-title').innerText = t.victory; document.getElementById('level-up-text').innerText = t.levelUp; document.getElementById('next-btn').innerText = t.continue;
        document.getElementById('skill-basic-name').innerText = t.skillBasic; document.getElementById('skill-q-name').innerText = t.skillQ; document.getElementById('skill-q-desc').innerText = t.skillQDesc; document.getElementById('skill-w-name').innerText = t.skillW; document.getElementById('skill-r-name').innerText = t.skillR;
        document.getElementById('choice-title').innerText = t.finalChoiceTitle; document.getElementById('btn-choice-attack').innerText = t.choiceAttack; document.getElementById('btn-choice-surrender').innerText = t.choiceSurrender;
        document.getElementById('btn-restart').innerText = t.restart;
        
        document.getElementById('restart-title').innerText = t.restartTitle;
        document.getElementById('restart-msg').innerText = t.restartMsg;
        document.getElementById('btn-restart-confirm').innerText = t.restartConfirm;
        document.getElementById('btn-restart-cancel').innerText = t.restartCancel;
        
        document.getElementById('shop-title-text').innerText = t.shop.title;
        document.getElementById('shop-close-btn').innerText = t.shop.close;
        document.getElementById('btn-open-shop').innerText = t.shop.btnShop;
        updateSellModeUI();
        
        if (!isIsoldeScene && document.getElementById('enemy-name').innerText !== "ENEMY" && document.getElementById('enemy-name').innerText !== "D√ú≈ûMAN") {
             document.getElementById('enemy-name').innerText = t.enemies[currentEnemyIndex].name.toUpperCase();
        }
    }
    
    function forcePlayMusic() { bgMusic.volume = musicVolume; bgMusic.play().catch(e => {}); }

    function toggleSellMode() {
        isSellMode = !isSellMode;
        document.body.classList.toggle('sell-mode-active', isSellMode);
        updateSellModeUI();
        openShop(); 
    }

    function updateSellModeUI() {
        const btn = document.getElementById('sell-mode-btn');
        btn.innerText = isSellMode ? t.shop.sellModeOn : t.shop.sellModeOff;
        btn.classList.toggle('active', isSellMode);
    }

    function openShop() {
        const modal = document.getElementById('shop-modal');
        const container = document.getElementById('shop-container');
        document.getElementById('shop-gold-display').innerText = `${player.gold} ${t.shop.gold}`;
        
        container.innerHTML = "";
        shopItems.forEach(item => {
            const itemTrans = t.shop.items[item.id]; 
            const div = document.createElement('div');
            div.className = 'shop-item';
            
            let btnText = "";
            let disabled = false;
            let isOwnedPassive = player.ownedPassives.includes(item.id);
            let hasConsumable = (item.id === 'potion' && player.potions > 0) || (item.id === 'elixir' && player.elixirs > 0);

            if (isSellMode) {
                 if ((item.type === 'passive' && isOwnedPassive) || (item.type === 'consumable' && hasConsumable)) {
                      btnText = `${t.shop.sell} (${Math.floor(item.basePrice / 2)} G)`;
                      div.classList.add(item.type === 'passive' ? 'owned-passive' : 'owned-consumable');
                 } else {
                      btnText = "-"; disabled = true;
                 }
            } else {
                if (item.type === 'passive') {
                    if (isOwnedPassive) { btnText = t.shop.owned; disabled = true; div.classList.add('owned-passive'); }
                    else {
                         btnText = `${t.shop.buy} (${item.basePrice} G)`;
                         if (player.gold < item.basePrice) disabled = true;
                    }
                } else { 
                      btnText = `${t.shop.buy} (${item.basePrice} G)`;
                      if (player.gold < item.basePrice) disabled = true;
                }
            }

            div.innerHTML = `
                <div class="item-info"><span class="item-name">${item.icon} ${itemTrans.name}</span><span class="item-desc">${itemTrans.desc}</span></div>
                <button class="buy-btn ${isSellMode ? 'sellable' : ''}" onclick="handleShopAction('${item.id}')" ${disabled ? 'disabled' : ''}>${btnText}</button>
            `;
            container.appendChild(div);
        });
        modal.style.display = 'block';
    }

    function closeShop() { document.getElementById('shop-modal').style.display = 'none'; isSellMode = false; document.body.classList.remove('sell-mode-active'); updateSellModeUI(); }

    function handleShopAction(id) {
        if (isSellMode) sellItem(id); else buyItem(id);
    }

    function buyItem(id) {
        const item = shopItems.find(i => i.id === id);
        if (item.type === 'passive' && player.ownedPassives.includes(id)) return;

        if (player.gold >= item.basePrice) {
            player.gold -= item.basePrice;
            if (item.type === 'consumable') {
                if (id === 'potion') player.potions++; else if (id === 'elixir') player.elixirs++;
            } else if (item.type === 'passive') {
                player.ownedPassives.push(id);
            }
            saveGame(); openShop(); updateUI(); updateInventoryUI(); updateEquippedUI();
        }
    }

    function sellItem(id) {
        const item = shopItems.find(i => i.id === id);
        let sold = false;

        if (item.type === 'passive' && player.ownedPassives.includes(id)) {
            player.ownedPassives = player.ownedPassives.filter(pId => pId !== id);
            sold = true;
        } else if (item.type === 'consumable') {
            if (id === 'potion' && player.potions > 0) { player.potions--; sold = true; }
            else if (id === 'elixir' && player.elixirs > 0) { player.elixirs--; sold = true; }
        }

        if (sold) {
            player.gold += Math.floor(item.basePrice / 2);
            saveGame(); openShop(); updateUI(); updateInventoryUI(); updateEquippedUI();
        }
    }

    function updateInventoryUI() {
        document.getElementById('count-potion').innerText = player.potions;
        document.getElementById('count-elixir').innerText = player.elixirs;
        document.querySelector('.inv-slot:nth-child(1)').classList.toggle('empty', player.potions === 0);
        document.querySelector('.inv-slot:nth-child(2)').classList.toggle('empty', player.elixirs === 0);
    }

    function updateEquippedUI() {
        const container = document.getElementById('equipped-container');
        container.innerHTML = "";
        player.ownedPassives.forEach(pId => {
            const item = shopItems.find(i => i.id === pId);
            if(item) createEquippedIcon(container, pId, item.icon);
        });
    }
    function createEquippedIcon(container, id, icon) {
        const div = document.createElement('div'); div.className = 'eq-item';
        div.innerHTML = `${icon}`;
        div.onmouseover = function() { 
            const itemTrans = t.shop.items[id];
            const tooltip = document.getElementById('inv-tooltip');
            tooltip.style.display = 'block'; tooltip.style.top = this.offsetTop + 50 + 'px'; tooltip.style.left = '60px';
            tooltip.innerHTML = `<span class="tooltip-title">${itemTrans.name}</span><span class="tooltip-desc">${itemTrans.desc}</span><span class="tooltip-stat">${itemTrans.stat}</span>`;
        };
        div.onmouseout = hideTooltip;
        container.appendChild(div);
    }

    function useInventoryItem(type) {
        if (turn !== 'player') return;
        if (type === 'potion') {
            if (player.potions > 0) {
                player.potions--;
                let healAmount = Math.max(20, Math.floor((player.maxHp - player.hp) * 0.10));
                player.hp = Math.min(player.maxHp, player.hp + healAmount);
                showFloatingText(document.getElementById('player-box'), `+${healAmount}`, "heal");
                log(t.logPotion); updateUI(); updateInventoryUI(); saveGame();
            } else { log(t.logPotionErr); }
        } else if (type === 'elixir') {
            if (player.elixirs > 0) {
                player.elixirs--;
                player.power = Math.min(player.maxPower, player.power + 40);
                showFloatingText(document.getElementById('player-box'), "+40 Power", "heal");
                log(t.logElixir); updateUI(); updateInventoryUI(); saveGame();
            } else { log(t.logElixirErr); }
        }
    }

    function showTooltip(el, type) {
        const tooltip = document.getElementById('inv-tooltip');
        tooltip.style.display = 'block'; tooltip.style.top = el.offsetTop + 'px'; tooltip.style.left = '85px';
        const itemTrans = t.shop.items[type]; 
        if (itemTrans) tooltip.innerHTML = `<span class="tooltip-title">${itemTrans.name}</span><span class="tooltip-desc">${itemTrans.desc}</span><span class="tooltip-stat">${itemTrans.stat}</span>`;
    }
    function hideTooltip() { document.getElementById('inv-tooltip').style.display = 'none'; }

    function showInfo(target) {
        const modal = document.getElementById('info-modal'); const content = document.getElementById('info-content');
        modal.style.display = 'block';
        if (target === 'player') { document.getElementById('info-title').innerText = "VIEGO"; content.innerHTML = mechanicsInfo.player; } 
        else { const id = enemiesBase[currentEnemyIndex].id; document.getElementById('info-title').innerText = id.toUpperCase(); content.innerHTML = mechanicsInfo[id] || mechanicsInfo.default; }
    }
    function closeInfo() { document.getElementById('info-modal').style.display = 'none'; }

    function startGame() { document.getElementById('start-screen').style.display = 'none'; forcePlayMusic(); loadLevel(currentEnemyIndex); }

    function loadLevel(index) {
        if (enemyTimeout) clearTimeout(enemyTimeout);
        if (index >= enemiesBase.length) { startIsoldeScene(); return; }
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('final-choice-overlay').style.display = 'none';
        currentEnemyIndex = index;
        const enemyData = enemiesBase[index];
        const enemyTrans = t.enemies[index];
        if (enemyData.id === 'mordekaiser') changeMusic('morde'); else if (enemyData.id === 'thresh') changeMusic('thresh'); else if (index < 5) changeMusic('tier1'); else if (index < 12) changeMusic('tier2'); else changeMusic('tier3');
        document.getElementById('enemy-name').innerText = enemyData.id.toUpperCase();
        document.getElementById('enemy-img').src = enemyData.img;
        document.getElementById('enemy-img').classList.remove('clone-active'); 
        document.getElementById('enemy-lvl').innerText = enemyData.level;
        enemyData.hp = enemyData.maxHp; 
        bossState = { isPlayerStunned: false, threshStacks: 0, threshVulnerable: false, belvethForm: 1, mordeRealmTriggered: false, mordeRealmActive: false, turnCount: 0, leblancClone: false, leblancHidden: false, leblancBuffTurns: 0 };
        document.body.classList.remove('death-realm-active'); 
        if(enemyData.id === 'belveth') document.getElementById('enemy-img').src = "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Belveth_0.jpg";
        player.ultUsed = false; player.power = 0; player.wCooldown = 0; player.nextHitCrit = false;
        turn = "player"; toggleBattleUI(false); 
        startPreFightDialogue(enemyTrans);
    }

    function startIsoldeScene() {
        isIsoldeScene = true; changeMusic('isolde');
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('enemy-name').innerText = "ISOLDE";
        document.getElementById('enemy-img').src = "https://ddragon.leagueoflegends.com/cdn/img/champion/splash/Gwen_1.jpg"; 
        document.getElementById('enemy-lvl').innerText = "‚àû";
        toggleBattleUI(false); currentDialogues = t.isolde.intro; dialogueIndex = 0;
        document.getElementById('cinematic-dialogue').style.display = 'flex'; updateDialogueText();
    }

    function startPreFightDialogue(enemyTrans) { currentDialogues = enemyTrans.intro; dialogueIndex = 0; document.getElementById('cinematic-dialogue').style.display = 'flex'; updateDialogueText(); }
    function updateDialogueText() { if(dialogueIndex < currentDialogues.length) { document.getElementById('cinematic-text').innerText = currentDialogues[dialogueIndex]; } else { endDialogue(); } }
    function nextDialogue() { dialogueIndex++; updateDialogueText(); }
    function endDialogue() { document.getElementById('cinematic-dialogue').style.display = 'none'; if (isIsoldeScene) { document.getElementById('final-choice-overlay').style.display = 'flex'; } else { toggleBattleUI(true); updateUI(); log(t.logStart); } }
    function makeFinalChoice(choice) {
        document.getElementById('final-choice-overlay').style.display = 'none';
        currentDialogues = choice === 'attack' ? t.isolde.endingAttack : t.isolde.endingSurrender;
        dialogueIndex = 0; isIsoldeScene = false; document.getElementById('cinematic-dialogue').style.display = 'flex';
        window.nextDialogue = function() { dialogueIndex++; if (dialogueIndex < currentDialogues.length) document.getElementById('cinematic-text').innerText = currentDialogues[dialogueIndex]; else { localStorage.removeItem('viegoRPG_save'); location.reload(); } };
        updateDialogueText();
    }

    function toggleBattleUI(show) { const elements = [document.getElementById('combat-controls'), document.getElementById('ui-hp-p'), document.getElementById('ui-mp-p'), document.getElementById('ui-hp-e')]; elements.forEach(el => { if(show) el.classList.remove('hidden-ui'); else el.classList.add('hidden-ui'); }); }
    function triggerBanter(isPlayerTurn) { if (Math.random() > 0.3) return; if (isPlayerTurn) { const quotes = t.playerQuotes; if(quotes) showSpeech('player', quotes[Math.floor(Math.random() * quotes.length)]); } else { const quotes = t.enemies[currentEnemyIndex].quotes; showSpeech('enemy', quotes[Math.floor(Math.random() * quotes.length)]); } }
    function showSpeech(who, text) { const bubble = document.getElementById(who + '-bubble'); bubble.innerText = text; bubble.classList.add('speech-visible'); }
    function clearBubbles() { document.getElementById('player-bubble').classList.remove('speech-visible'); document.getElementById('enemy-bubble').classList.remove('speech-visible'); }

    function useSkill(type) {
        if (turn !== "player") return;
        if (bossState.isPlayerStunned) { log(t.bossLogs.stunned); bossState.isPlayerStunned = false; turn = "enemy"; setTimeout(enemyTurn, 1000); return; }
        const enemyData = enemiesBase[currentEnemyIndex];
        
        if (enemyData.id === 'leblanc' && bossState.leblancHidden) {
            log(t.bossLogs.decoy); showFloatingText(document.getElementById('enemy-box'), t.bossLogs.decoy, "text-special");
            bossState.leblancHidden = false; bossState.leblancBuffTurns = 2; log(t.bossLogs.leblancEnraged);
            document.getElementById('enemy-img').classList.remove('clone-active'); turn = "enemy"; setTimeout(enemyTurn, 1000); return;
        }

        let damage = 0; let logMsg = ""; let isCrit = false;
        if (player.nextHitCrit) { isCrit = true; player.nextHitCrit = false; } else { if (Math.random() < player.critChance) isCrit = true; }

        if (type === 'basic') { 
            playSkillSound('basic'); damage = 15 + player.baseDmgBonus + (player.level * 5); player.power += (isCrit ? 15 : 10); logMsg = t.logViegoBasic; 
            if(player.ownedPassives.includes('vampScepter')) {
                player.hp = Math.min(player.maxHp, player.hp + 10);
                showFloatingText(document.getElementById('player-box'), "+10", "heal");
            }
        } 
        else if (type === 'q') { if (player.power < 15) { log(t.logNoPower); return; } playSkillSound('q'); player.power -= 15; damage = 30 + (player.level * 8); logMsg = t.logViegoQ; let heal = Math.max(5, Math.floor(enemyData.hp * 0.07)); player.hp = Math.min(player.maxHp, player.hp + heal); showFloatingText(document.getElementById('player-box'), `+${heal}`, 'heal'); }
        else if (type === 'w') { if (player.wCooldown > 0 || player.power < 25) { log(t.logCooldown); return; } playSkillSound('w'); player.power -= 25; damage = Math.min(80, 40 + (player.level * 6)); player.nextHitCrit = true; player.wCooldown = 3; logMsg = t.logViegoW; if(enemyData.id === 'thresh') { bossState.threshVulnerable = true; showFloatingText(document.getElementById('enemy-box'), "GUARD BROKEN!", "text-weakness"); } }
        else if (type === 'r') { if (player.ultUsed) { log(t.logUltUsed); return; } playSkillSound('r'); player.ultUsed = true; damage = 60 + (player.level * 9) + Math.floor((enemyData.maxHp - enemyData.hp) * 0.12); triggerEffect('ult'); logMsg = t.logViegoR; }

        if (isCrit && type !== 'w') { damage = type === 'q' ? Math.floor(damage * 1.75) : damage * 2; logMsg += t.logCrit; }
        player.power = Math.min(player.maxPower, player.power);

        if (enemyData.id === 'thresh') { let reduction = 15 + (bossState.threshStacks * 3); if(bossState.threshVulnerable && damage > 0) { damage *= 2; showFloatingText(document.getElementById('enemy-box'), "CRITICAL BREAK!", "text-weakness"); bossState.threshVulnerable = false; } let blocked = Math.min(damage, reduction); damage = Math.max(0, damage - reduction); if(blocked > 0) { let heal = Math.floor(blocked * 0.05); enemyData.hp = Math.min(enemyData.maxHp, enemyData.hp + heal); showFloatingText(document.getElementById('enemy-box'), `+${heal}`, 'heal'); } }
        if (enemyData.id === 'mordekaiser' && bossState.mordeRealmActive) damage = Math.floor(damage * 0.7);

        enemyData.hp -= damage;
        document.getElementById('player-box').classList.add('attacking'); setTimeout(() => document.getElementById('player-box').classList.remove('attacking'), 300);
        triggerDamageAnim('enemy-box');

        if (enemyData.id === 'leblanc' && !bossState.leblancClone && (enemyData.hp / enemyData.maxHp) < 0.4) { bossState.leblancClone = true; bossState.leblancHidden = true; log(t.bossLogs.leblancClone); document.getElementById('enemy-img').classList.add('clone-active'); }
        if (enemyData.id === 'belveth' && enemyData.hp <= 0 && bossState.belvethForm === 1) { enemyData.hp = 1200; bossState.belvethForm = 2; document.getElementById('enemy-img').src = "belveth2form.jpg"; log(t.bossLogs.belvethTransform); triggerEffect('void'); showFloatingText(document.getElementById('enemy-box'), "TRANSFORM!", "damage"); updateUI(); return; }
        if (enemyData.id === 'mordekaiser' && !bossState.mordeRealmTriggered && (enemyData.hp / enemyData.maxHp) <= 0.35) { bossState.mordeRealmTriggered = true; bossState.mordeRealmActive = true; document.body.classList.add('death-realm-active'); let missing = enemyData.maxHp - enemyData.hp; enemyData.hp += Math.floor(missing * 0.05); enemyData.maxHp = Math.floor(enemyData.maxHp * 1.25); enemyData.hp = Math.floor(enemyData.hp * 1.25); log(t.bossLogs.mordeRealm); showFloatingText(document.getElementById('enemy-box'), "DEATH REALM!", "text-special"); }

        enemyData.hp = Math.max(0, enemyData.hp);
        showFloatingText(document.getElementById('enemy-box'), damage, isCrit ? 'crit' : 'normal'); log(`${logMsg} ${damage} ${t.logDamage}`); updateUI();

        if (enemyData.hp <= 0) { winBattle(); return; }
        turn = "enemy"; enemyTimeout = setTimeout(enemyTurn, 1500);
    }

    function enemyTurn() {
        clearBubbles(); triggerBanter(false);
        const enemyData = enemiesBase[currentEnemyIndex]; const enemyTrans = t.enemies[currentEnemyIndex];
        let dmg = enemyData.damage + Math.floor(Math.random() * 10); bossState.turnCount++;

        if (enemyData.id === 'leblanc') { let isMimic = false; if (bossState.leblancBuffTurns > 0) { isMimic = true; bossState.leblancBuffTurns--; } else if (Math.random() < 0.4) { isMimic = true; } if (isMimic) { log(t.bossLogs.leblancMimic); dmg = Math.floor(dmg * 2.2); showFloatingText(document.getElementById('enemy-box'), "MIMIC!", "text-special"); } }
        if (enemyData.id === 'thresh') { bossState.threshStacks += 3; dmg += (bossState.threshStacks * 2); if (bossState.threshStacks % 12 === 0) { bossState.isPlayerStunned = true; triggerEffect('stun'); showFloatingText(document.getElementById('player-box'), "STUNNED", "text-special"); } }
        if (enemyData.id === 'belveth') { dmg += 10 * bossState.belvethForm; }
        if (enemyData.id === 'mordekaiser' && bossState.mordeRealmActive) { dmg = Math.floor(dmg * 1.3); let ls = Math.floor(dmg * 0.75); enemyData.hp = Math.min(enemyData.maxHp, enemyData.hp + ls); showFloatingText(document.getElementById('enemy-box'), `+${ls}`, 'heal'); }

        let reduction = Math.floor(dmg * (player.armor / 100)); dmg -= reduction;
        player.hp = Math.max(0, player.hp - dmg);
        if (player.wCooldown > 0) player.wCooldown--;

        if(player.ownedPassives.includes('thornmail') && dmg > 0) {
            enemyData.hp = Math.max(0, enemyData.hp - 15);
            showFloatingText(document.getElementById('enemy-box'), "15", "text-special");
            log("Thornmail reflected 15 damage!");
        }

        document.getElementById('enemy-box').classList.add('attacking'); setTimeout(() => document.getElementById('enemy-box').classList.remove('attacking'), 300);
        triggerDamageAnim('player-box');
        triggerEffect('damage'); showFloatingText(document.getElementById('player-box'), `-${dmg}`, 'damage'); updateUI();
        log(`${enemyTrans.name} ${t.logEnemyAtk} ${dmg}.`);
        if (player.hp <= 0) { log(t.logDefeat); setTimeout(() => { localStorage.removeItem('viegoRPG_save'); showDefeatScreen(); }, 1000); return; }
        turn = "player";
    }

    function winBattle() {
        if (enemyTimeout) clearTimeout(enemyTimeout);
        const enemyTrans = t.enemies[currentEnemyIndex];
        document.getElementById('overlay-title').innerText = t.victory; document.getElementById('overlay-title').style.color = "var(--ruined-green)"; document.getElementById('overlay-quote').innerText = enemyTrans.win; 
        player.level++; player.maxHp += 50; player.hp = player.maxHp; player.gold += 100; 
        document.getElementById('level-up-text').innerText = `${t.levelUp} (+100 ${t.shop.gold})`; document.getElementById('level-up-text').style.display = 'block';
        const btnContainer = document.getElementById('overlay-buttons');
        btnContainer.innerHTML = `<button class="start-btn" id="btn-open-shop" onclick="openShop()">${t.shop.btnShop}</button><button class="start-btn" id="next-btn" onclick="nextLevel()">${t.continue}</button>`;
        document.getElementById('overlay').style.display = 'flex';
        saveGame(); // Oyunu Kaydet
    }

    function nextLevel() { document.getElementById('overlay').style.display = 'none'; currentEnemyIndex++; loadLevel(currentEnemyIndex); saveGame(); }

    function updateUI() {
        const enemyData = enemiesBase[currentEnemyIndex];
        document.getElementById('player-hp-bar').style.width = (player.hp / player.maxHp) * 100 + '%'; document.getElementById('player-hp-text').innerText = `${Math.floor(player.hp)}/${player.maxHp}`;
        document.getElementById('player-power-bar').style.width = (player.power / player.maxPower) * 100 + '%'; document.getElementById('player-power-text').innerText = `${player.power}/${player.maxPower}`;
        document.getElementById('player-lvl').innerText = player.level;
        document.getElementById('enemy-hp-bar').style.width = (enemyData.hp / enemyData.maxHp) * 100 + '%'; document.getElementById('enemy-hp-text').innerText = `${Math.floor(enemyData.hp)}/${enemyData.maxHp}`;
        document.getElementById('player-gold').innerText = player.gold;
        let status = ""; if(enemyData.id==='thresh') status=`Souls: ${bossState.threshStacks}`; else if(enemyData.id==='belveth') status=`Form: ${bossState.belvethForm}`; else if(enemyData.id==='mordekaiser') status=bossState.mordeRealmActive?"DEATH REALM":"Iron";
        document.getElementById('boss-status').innerText = status;
        document.getElementById('btn-q').disabled = player.power < 15; document.getElementById('btn-w').disabled = (player.power < 25 || player.wCooldown > 0); document.getElementById('btn-ult').disabled = player.ultUsed;
        let bDmg = 15 + player.baseDmgBonus + (player.level*5); document.getElementById('skill-basic-cost').innerText = `~${bDmg} Dmg | +Power`;
        let qDmg = 30 + (player.level*8); document.getElementById('skill-q-cost').innerText = `~${qDmg} Dmg | 15 Pwr`;
        let wDmg = Math.min(80, 40+(player.level*6)); document.getElementById('skill-w-cost').innerText = `~${wDmg} Dmg | 25 Pwr`;
        let rDmg = 60+(player.level*9)+Math.floor((enemyData.maxHp-enemyData.hp)*0.12); document.getElementById('skill-r-cost').innerText = `~${rDmg} Dmg | 1 Use`;
    }

    function log(msg) { const box = document.getElementById('combat-log'); box.innerHTML = `> ${msg}<br>` + box.innerHTML; }
    function triggerDamageAnim(boxId) { const box = document.getElementById(boxId); box.classList.add('damaged'); setTimeout(() => box.classList.remove('damaged'), 400); }
    function triggerEffect(type) { const flash = document.getElementById('flash-effect'); flash.className = ''; if (type === 'damage') flash.classList.add('damage-flash'); if (type === 'ult') flash.classList.add('ult-flash'); if (type === 'stun') flash.classList.add('stun-flash'); if (type === 'void') flash.classList.add('void-flash'); setTimeout(() => flash.className = '', 500); }
    function showFloatingText(target, val, type) { const text = document.createElement('div'); text.className = 'float-text ' + (type === 'crit' ? 'text-crit' : (type === 'heal' ? 'text-heal' : (type === 'damage' ? 'text-enemy-dmg' : (type === 'text-special' ? 'text-special' : (type === 'text-weakness' ? 'text-weakness' : 'text-damage'))))); text.innerText = type === 'crit' ? val + "!" : val; const rect = target.getBoundingClientRect(); text.style.left = (rect.left + rect.width / 2) + 'px'; text.style.top = rect.top + 'px'; document.body.appendChild(text); setTimeout(() => text.remove(), 1200); }

    window.onload = function() {
        const savedLang = localStorage.getItem('rpgLang') || 'en';
        document.getElementById('lang-select').value = savedLang;
        changeLanguage(savedLang);
        loadSettings(); // √ñNCE AYARLARI Y√úKLE
        loadGame(); // SONRA OYUNU Y√úKLE
    };
</script>
</body>
</html>
